<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>IB-QRko-do v5</title>

<style>
body { font-family: Arial; margin: 0; padding: 20px; background: #fff; color: #000; }
h2 { text-align: center; margin-bottom: 20px; }
.container { max-width: 900px; margin: auto; }
.grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px 20px; }
.item label { font-size: 14px; display:block; }
.item input { width: 100%; padding: 10px; border:1px solid #888; border-radius: 8px; font-size:16px; }

button { width:100%; padding:14px 0; margin-top:10px; border-radius:10px; border:none;
         font-size:18px; font-weight:bold; color:#fff; }
.btn-main { background:#2b7cff; }
.btn-second { background:#555; }
.btn-danger { background:#c62828; }

#qrcode { text-align:center; margin-top:20px; }
canvas { display:none; }

#updateToast {
  position: fixed; left:50%; bottom:30px; transform:translateX(-50%);
  background:#333; color:#fff; padding:12px 20px; border-radius:8px;
  font-size:16px; display:none; z-index:9999;
}
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jsqr/1.4.0/jsQR.min.js"></script>

<link rel="manifest" href="manifest.json">

<script>
// =========================
// Service Worker 自动更新
// =========================
if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("service-worker.js")
    .then(reg => {
        reg.onupdatefound = () => {
            const newSW = reg.installing;
            newSW.onstatechange = () => {
                if (newSW.state === "installed" && navigator.serviceWorker.controller) {
                    showUpdateToast();
                }
            };
        };
    });
}

function showUpdateToast(){
    const t=document.getElementById("updateToast");
    t.style.display="block";
    setTimeout(()=>location.reload(),1500);
}
</script>

</head>

<body>
<h2>IB-QRko-do v5（オフライン・自動更新）</h2>

<div id="updateToast">新しいバージョンを読み込み中…</div>

<div class="container">

<div class="item">
<label>QR 名称（黒地白文字）</label>
<input id="qrTitle" placeholder="例：定型0300（2A補正値）">
</div>

<div id="inputs" class="grid"></div>

<script>
// =========================
// 80 个项目字段名称（依然保持你的顺序）
// =========================
const labels = [
"1. 定型番号","2. 生産数量","3. シート長さ","4. シート幅","5. シート厚み",
"6. 長さL","7. 幅B","8. 高さH","9. 糊代","10. 複数(丁付)",
"11. ハーフ","12. O","13. I（I1）","14. h","15. T",
"16. Max½L(MaxA)","17. Max½(MaxB)W","18. 予備19","19. 予備20","20. 予備21",
"21. 予備22","22. 予備23","23. 予備24","24. 予備25","25. 縦断裁数量",
"26. 横断裁数量 予備","27. 段違い罫線ON/OFF（0→OFF/1→ON）",
"28. 罫線間隔1","29. 罫線間隔2","30. L1","31. L2",
"32. L3","33. L4","34. L5","35. L6","36. L7",
"37. L8","38. L9","39. L10","40. L11","41. L12",
"42. L13","43. L14","44. L15","45. L16","46. W1",
"47. W2","48. W3","49. W4","50. W5","51. W6",
"52. W7","53. W8","54. W9","55. iOffsetHeight","56. iOffsetL1",
"57. iOffsetL2","58. iOffsetL3","59. iOffsetL4","60. iOffsetL5","61. iOffsetL6",
"62. iOffsetL7","63. iOffsetL8","64. iOffsetL9","65. iOffsetL10","66. iOffsetL11",
"67. iOffsetL12","68. iOffsetL13","69. iOffsetL14","70. iOffsetL15","71. iOffsetL16",
"72. iOffsetW1","73. iOffsetW2","74. iOffsetW3","75. iOffsetW4","76. iOffsetW5",
"77. iOffsetW6","78. iOffsetW7","79. iOffsetW8","80. iOffsetW9"
];

// ------------------------------
// 初始化输入框
// ------------------------------
const container = document.getElementById("inputs");
labels.forEach((label, index) => {
    const item = document.createElement("div");
    item.className = "item";
    const id = "f" + (index + 1);
    item.innerHTML = `<label>${label}</label>
                      <input id="${id}" type="text">`;
    container.appendChild(item);
});

// ------------------------------
// 自动保存 & 自动恢复
// ------------------------------
function saveAll(){
    labels.forEach((_,i)=>{
        const id = "f"+(i+1);
        localStorage.setItem(id, document.getElementById(id).value);
    });
    localStorage.setItem("qrTitle", document.getElementById("qrTitle").value);
}

document.querySelectorAll("input").forEach(inp=>{
    inp.addEventListener("input", saveAll);
});

function restore(){
    labels.forEach((_,i)=>{
        const id = "f"+(i+1);
        const v = localStorage.getItem(id);
        if(v!==null) document.getElementById(id).value = v;
    });
    const t = localStorage.getItem("qrTitle");
    if(t!==null) document.getElementById("qrTitle").value = t;
}
restore();

// ------------------------------
// 生成 QR
// ------------------------------
function generateQR(){
    let data = [];
    labels.forEach((_,i)=>{
        const id="f"+(i+1);
        let v = document.getElementById(id).value.trim();
        if(v==="") v="0";
        data.push(v);
    });

    const finalStr = data.join(";");

    let qr = new QRious({
        value: finalStr,
        size: 400,
        level: "H"
    });

    document.getElementById("qr-image").src = qr.toDataURL("image/png");
    document.getElementById("qr-name").innerText =
        document.getElementById("qrTitle").value || "QR コード";
}

// ------------------------------
// QR 反向解析
// ------------------------------
function decodeQR(){
    const file = document.getElementById("qrFile").files[0];
    if (!file) return alert("QR画像を選択してください。");

    const img = new Image();
    img.onload = () => {
        const c = document.createElement("canvas");
        c.width = img.width;
        c.height = img.height;
        const ctx = c.getContext("2d");
        ctx.drawImage(img, 0, 0);

        const imgData = ctx.getImageData(0,0,c.width,c.height);
        const code = jsQR(imgData.data, imgData.width, imgData.height);

        if(code){
            let arr = code.data.split(";");

            labels.forEach((_,i)=>{
                const id="f"+(i+1);
                document.getElementById(id).value = arr[i] || "";
            });

            saveAll();
        }else{
            alert("QRを解析できませんでした。");
        }
    };
    img.src = URL.createObjectURL(file);
}
</script>

<!-- 操作按钮 -->
<button class="btn-main" onclick="generateQR()">QR を生成</button>
<button class="btn-second" onclick="decodeQR()">QR を解析</button>
<button class="btn-danger" onclick="localStorage.clear();location.reload();">全てリセット</button>

<div id="qrcode">
    <h3 id="qr-name"></h3>
    <img id="qr-image" style="width:300px; margin-top:20px;">
</div>

<input type="file" id="qrFile" accept="image/*" style="margin-top:20px;">

</div>
</body>
</html>
