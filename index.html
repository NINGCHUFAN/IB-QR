
<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>IB-QRko-do v9</title>
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="theme-color" content="#0b0f14">

<style>
body { font-family: Arial; margin: 0; padding: 20px; background: #fff; color: #000; }
h2 { text-align: center; margin-bottom: 20px; }
.container { max-width: 900px; margin: auto; }
.grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px 20px; }
.item label { font-size: 14px; display:block; }
.item input { width: 100%; padding: 10px; border:1px solid #888; border-radius: 8px; font-size:16px; }

button { width:100%; padding:14px 0; margin-top:10px; border-radius:10px; border:none;
         font-size:18px; font-weight:bold; color:#fff; }
.btn-main { background:#2b7cff; }
.btn-second { background:#555; }
.btn-danger { background:#c62828; }

#qrcode { text-align:center; margin-top:20px; }
canvas { display:none; }
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jsqr/1.4.0/jsQR.min.js"></script>
</head>

<body>
<h2>IBーQRコード生成器 <span style="font-size:14px;color:#666;">v9</span></h2>

<div class="container">

<div class="item">
<label>QR 名称（黒地白文字）</label>
<input id="qrTitle" placeholder="例：定型0300（2A補正値）">
</div>

<div id="inputs" class="grid"></div>

<button class="btn-main" onclick="generateQR()">QRコード生成</button>
<button class="btn-second" onclick="downloadQR()">QR画像ダウンロード</button>
<button class="btn-second" onclick="loadQR()">QR解析（画像読込）</button>
<button class="btn-second" onclick="saveCSV()">CSV出力</button>
<button class="btn-danger" onclick="clearAll()">全入力クリア</button>

<div id="qrcode"></div>
<canvas id="qr-canvas"></canvas>

</div>

<script>
// ラベルリスト
const labels = ["定型番号","生産数量","シート長さ","シート幅","シート厚み","長さL","幅B","高さH","糊代","複数(丁付)","ハーフ","O","I ( I1 )","h","T","Max½L(MaxA)","Max½(MaxB)W","予備19","予備20","予備21","予備22","予備23","循環(cycle)","縦断裁数量","横断裁数量","予備25","段違い罫線ON/OFF（0→OFF/1→ON）","段違い罫線の間隔1","段違い罫線の間隔2","L1","L2","L3","L4","L5","L6","L7","L8","L9","L10","L11","L12","L13","L14","L15","L16","W1","W2","W3","W4","W5","W6","W7","W8","W9","iOffsetHeight","iOffsetL1","iOffsetL2","iOffsetL3","iOffsetL4","iOffsetL5","iOffsetL6","iOffsetL7","iOffsetL8","iOffsetL9","iOffsetL10","iOffsetL11","iOffsetL12","iOffsetL13","iOffsetL14","iOffsetL15","iOffsetL16","iOffsetW1","iOffsetW2","iOffsetW3","iOffsetW4","iOffsetW5","iOffsetW6","iOffsetW7","iOffsetW8","iOffsetW9"];

const container = document.getElementById("inputs");

// 入力欄生成（二列）
labels.forEach((label,i)=>{
    container.innerHTML += 
        "<div class='item'>" +
        "<label>" + (i) + ". " + label + "</label>" +
        "<input id='input" + i + "' value='" + (localStorage.getItem("qr"+i) || "") + "'>" +
        "</div>";
});

// QR生成（600×600 + タイトル黒地白文字）
function generateQR(){
    let vals=[];
    for(let i=0;i<80;i++){
        let v=document.getElementById("input"+i).value.trim();
        if(v==="") v="0";
        vals.push(v);
        localStorage.setItem("qr"+i, v);
    }
    const data = vals.join(";");
    const title=document.getElementById("qrTitle").value || "QRコード";

    let qr=new QRious({ value:data, size:600, level:"M" });

    let canvas=document.createElement("canvas");
    let ctx=canvas.getContext("2d");
    let titleHeight=50;

    canvas.width=600;
    canvas.height=650;

    ctx.fillStyle="black";
    ctx.fillRect(0,0,600,titleHeight);

    ctx.fillStyle="white";
    ctx.font="bold 22px Arial";
    ctx.textAlign="center";
    ctx.fillText(title,300,35);

    ctx.drawImage(qr.canvas,0,titleHeight);

    document.getElementById("qrcode").innerHTML =
        "<img id='finalQR' src='" + canvas.toDataURL("image/png") + "' style='width:300px;'>";
}

// 画像保存
function downloadQR(){
    let img=document.getElementById("finalQR");
    if(!img){ alert("先にQRを生成してください"); return; }
    let a=document.createElement("a");
    a.href=img.src;
    a.download="QR.png";
    a.click();
}

// 全クリア
function clearAll(){
    if(!confirm("全て消去しますか？")) return;
    for(let i=0;i<80;i++){
        document.getElementById("input"+i).value="";
        localStorage.removeItem("qr"+i);
    }
    document.getElementById("qrcode").innerHTML="";
}

// CSV出力
function saveCSV(){
    let rows=[];
    for(let i=0;i<80;i++){
        let v=document.getElementById("input"+i).value||"0";
        rows.push(labels[i] + "," + v);
    }
    let blob=new Blob([rows.join("\n")],{type:"text/csv"});
    let a=document.createElement("a");
    a.href=URL.createObjectURL(blob);
    a.download="qrdata.csv";
    a.click();
}

// QR解析
function loadQR(){
    let input=document.createElement("input");
    input.type="file"; input.accept="image/*";
    input.onchange=e=>{
        let file=e.target.files[0];
        let reader=new FileReader();
        reader.onload=()=>decodeQR(reader.result);
        reader.readAsDataURL(file);
    };
    input.click();
}

function decodeQR(dataURL){
    let img=new Image();
    img.onload=()=>{
        let c=document.getElementById("qr-canvas");
        let ctx=c.getContext("2d");
        c.width=img.width; c.height=img.height;
        ctx.drawImage(img,0,0);
        let d=ctx.getImageData(0,0,c.width,c.height);
        let code=jsQR(d.data,c.width,c.height);
        if(code){
            let arr=code.data.split(";");
            arr.forEach((v,i)=>{
                if(document.getElementById("input"+i))
                    document.getElementById("input"+i).value=v;
            });
            alert("QR解析成功");
        } else alert("解析失敗");
    };
    img.src=dataURL;
}
</script>


<script>
  // PWA offline & updates
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', async () => {
      try {
        const reg = await navigator.serviceWorker.register('./service-worker.js');
        // Listen for updates
        reg.addEventListener('updatefound', () => {
          const nw = reg.installing;
          if (!nw) return;
          nw.addEventListener('statechange', () => {
            if (nw.state === 'installed' && navigator.serviceWorker.controller) {
              // Show a simple update notice (non-blocking)
              const bar = document.createElement('div');
              bar.textContent = '更新あり：再起動すると最新版になります';
              bar.style.cssText = 'position:fixed;left:16px;right:16px;bottom:88px;background:#111;color:#fff;padding:12px 14px;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.18);z-index:9999;font-size:14px;';
              const btn = document.createElement('button');
              btn.textContent = '更新';
              btn.style.cssText = 'margin-left:12px;background:#1e78ff;color:#fff;border:0;border-radius:10px;padding:8px 12px;font-weight:700;';
              btn.onclick = () => {
                reg.waiting?.postMessage({type:'SKIP_WAITING'});
                setTimeout(()=>location.reload(), 300);
              };
              bar.appendChild(btn);
              document.body.appendChild(bar);
            }
          });
        });
        navigator.serviceWorker.addEventListener('controllerchange', () => {
          // auto refresh when new SW takes control
        });
      } catch(e) { /* ignore */ }
    });
  }
</script>

</body>
</html>
